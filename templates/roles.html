{% extends "base.html" %}
{% block title %}Rolês Hoje{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Rolês Hoje</h1>
    <p class="text-center">Escolha como deseja buscar os rolês próximos.</p>

    <!-- Escolha do modo -->
    <div class="mb-4 text-center">
        <label for="modo-busca" class="form-label">Modo de busca:</label>
        <select id="modo-busca" class="form-select w-auto d-inline-block">
            <option value="coord" selected>Por minha localização</option>
            <option value="cidade">Por cidade</option>
        </select>
    </div>

    <!-- Modo 1: Pela coordenada -->
    <div id="busca-coord" class="card p-4 shadow">
        <h5 class="mb-3">Buscar por minha localização</h5>
        <p id="coords" class="text-muted">Clique no botão para buscar rolês próximos de você.</p>
        <button id="btn-localizacao" class="btn btn-primary w-100">Buscar Rolês Próximos</button>
        <ul id="roles-coord" class="mt-3 list-group"></ul>
    </div>

    <!-- Modo 2: Por cidade -->
    <div id="busca-cidade" class="card p-4 shadow d-none">
        <h5 class="mb-3">Buscar por cidade</h5>
        <input type="text" id="cidade" class="form-control" placeholder="Digite o nome da cidade">
        <button id="btn-cidade" class="btn btn-success w-100 mt-3">Buscar Rolês na Cidade</button>
        <ul id="roles-cidade" class="mt-3 list-group"></ul>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const modoBusca = document.getElementById("modo-busca");
    const buscaCoord = document.getElementById("busca-coord");
    const buscaCidade = document.getElementById("busca-cidade");

    modoBusca.addEventListener("change", function () {
        if (modoBusca.value === "coord") {
            buscaCoord.classList.remove("d-none");
            buscaCidade.classList.add("d-none");
        } else {
            buscaCoord.classList.add("d-none");
            buscaCidade.classList.remove("d-none");
        }
    });

    // Buscar por coordenada
    document.getElementById("btn-localizacao").addEventListener("click", function () {
        const coordsEl = document.getElementById("coords");
        const rolesCoordEl = document.getElementById("roles-coord");

        if (navigator.geolocation) {
            coordsEl.innerHTML = "Obtendo localização...";
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const lat = position.coords.latitude.toFixed(6);
                    const lon = position.coords.longitude.toFixed(6);
                    coordsEl.innerHTML = `Latitude: ${lat}, Longitude: ${lon}`;

                    fetch(`/roles-perto/?lat=${lat}&lon=${lon}`)
                        .then(res => res.json())
                        .then(data => {
                            rolesCoordEl.innerHTML = "";
                            if (data.roles.length === 0) {
                                rolesCoordEl.innerHTML = `<li class="list-group-item">Nenhum rolê encontrado próximo.</li>`;
                            } else {
                                data.roles.forEach(role => {
                                    rolesCoordEl.innerHTML += `
                                        <li class="list-group-item">
                                            <strong>${role.nome}</strong> - ${role.distancia_km} km<br>
                                            <small>${role.descricao}</small>
                                        </li>
                                    `;
                                });
                            }
                        });
                },
                () => coordsEl.innerHTML = "Não foi possível obter sua localização."
            );
        }
    });

    // Buscar por cidade
    document.getElementById("btn-cidade").addEventListener("click", function () {
        const cidade = document.getElementById("cidade").value.trim();
        const rolesCidadeEl = document.getElementById("roles-cidade");

        if (!cidade) {
            alert("Digite o nome de uma cidade.");
            return;
        }

        fetch(`/roles-cidade/?cidade=${encodeURIComponent(cidade)}`)
            .then(res => res.json())
            .then(data => {
                rolesCidadeEl.innerHTML = "";
                if (data.roles.length === 0) {
                    rolesCidadeEl.innerHTML = `<li class="list-group-item">Nenhum rolê encontrado nessa cidade.</li>`;
                } else {
                    data.roles.forEach(role => {
                        rolesCidadeEl.innerHTML += `
                            <li class="list-group-item">
                                <strong>${role.nome}</strong><br>
                                <small>${role.descricao}</small>
                            </li>
                        `;
                    });
                }
            });
    });
});
</script>

{% endblock %}
